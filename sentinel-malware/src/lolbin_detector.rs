//! Module 19: LOLBinDetector — Living Off the Land Binary Detection
//!
//! Detects abuse of legitimate system binaries for malicious purposes.
//! LOLBins are trusted OS utilities weaponized by attackers to bypass
//! application whitelisting and avoid dropping custom malware.
//!
//! ## Features
//!
//! - **Comprehensive LOLBin database**: 100+ macOS/Linux binaries with known abuse patterns
//! - **Context-aware detection**: Same binary may be legitimate in one context, malicious in another
//! - **Argument analysis**: Pattern-matches command-line args against known abuse signatures
//! - **Parent process validation**: Flags LOLBins spawned by unexpected parents
//! - **Network activity correlation**: Detects LOLBins making outbound connections
//! - **File write monitoring**: Flags LOLBins writing to sensitive directories
//! - **Chained LOLBin detection**: Identifies multi-stage LOLBin chains
//! - **MITRE ATT&CK mapping**: Every detection maps to specific technique IDs
//! - **Baseline learning**: Learns normal LOLBin usage patterns to reduce FPs
//! - **macOS-specific**: osascript, security, defaults, dscl, xattr, spctl, etc.
//!
//! ## Memory Breakthroughs Used
//!
//! All 13 sentinel-core breakthroughs are integrated.

use crate::types::*;
use sentinel_core::tiered_cache::TieredCache;
use sentinel_core::hierarchical::HierarchicalState;
use sentinel_core::reversible::ReversibleComputation;
use sentinel_core::streaming::StreamAccumulator;
use sentinel_core::differential::DifferentialStore;
use sentinel_core::sparse::SparseMatrix;
use sentinel_core::pruning::PruningMap;
use sentinel_core::dedup::DedupStore;
use sentinel_core::compression;
use sentinel_core::MemoryMetrics;

use std::collections::{HashMap, HashSet};
use std::sync::atomic::{AtomicU64, Ordering};
use parking_lot::RwLock;
use tracing::{info, warn, debug};

// ── Constants ───────────────────────────────────────────────────────────────

const DETECTION_CACHE_MAX: usize = 10_000;
const HISTORY_LEVELS: u32 = 6;
const HISTORY_PER_LEVEL: usize = 64;
const STATS_WINDOW: usize = 256;

// ── LOLBin Signature Database ───────────────────────────────────────────────

#[derive(Debug, Clone)]
struct LolBinSignature {
    binary: &'static str,
    category: LolBinCategory,
    abuse_patterns: &'static [&'static str],
    mitre_ids: &'static [&'static str],
    severity: Severity,
    description: &'static str,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, serde::Serialize, serde::Deserialize)]
pub enum LolBinCategory {
    Execution,
    Download,
    Encode,
    Compile,
    Persistence,
    CredentialAccess,
    Discovery,
    Evasion,
    LateralMovement,
    Exfiltration,
}

/// macOS + cross-platform LOLBin database
const LOLBIN_DB: &[LolBinSignature] = &[
    // ── Execution ───────────────────────────────────────────────────────
    LolBinSignature {
        binary: "osascript",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-e", "do shell script", "tell application", "curl", "wget", "python"],
        mitre_ids: &["T1059.002"],
        severity: Severity::High,
        description: "AppleScript execution — can run shell commands, display fake dialogs",
    },
    LolBinSignature {
        binary: "python",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-c 'import socket", "-c 'import os", "-c 'import subprocess", "exec(", "eval("],
        mitre_ids: &["T1059.006"],
        severity: Severity::High,
        description: "Python one-liner execution for reverse shells or code injection",
    },
    LolBinSignature {
        binary: "python3",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-c 'import socket", "-c 'import os", "-c 'import subprocess", "exec(", "eval("],
        mitre_ids: &["T1059.006"],
        severity: Severity::High,
        description: "Python3 one-liner execution",
    },
    LolBinSignature {
        binary: "perl",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-e 'use Socket", "-e 'exec", "IO::Socket"],
        mitre_ids: &["T1059"],
        severity: Severity::High,
        description: "Perl reverse shell or command execution",
    },
    LolBinSignature {
        binary: "ruby",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-rsocket", "-e 'TCPSocket", "IO.popen"],
        mitre_ids: &["T1059"],
        severity: Severity::High,
        description: "Ruby reverse shell",
    },
    LolBinSignature {
        binary: "swift",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-e", "import Foundation", "Process()", "NSTask"],
        mitre_ids: &["T1059"],
        severity: Severity::Medium,
        description: "Swift REPL command execution",
    },
    LolBinSignature {
        binary: "bash",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-i >& /dev/tcp/", "| base64 -d |", "eval \"$(curl", "<(curl"],
        mitre_ids: &["T1059.004"],
        severity: Severity::High,
        description: "Bash reverse shell or download cradle",
    },
    // ── Download ────────────────────────────────────────────────────────
    LolBinSignature {
        binary: "curl",
        category: LolBinCategory::Download,
        abuse_patterns: &["| sh", "| bash", "-o /tmp/", "-O /tmp/", "--output /tmp/", "| python"],
        mitre_ids: &["T1105"],
        severity: Severity::High,
        description: "curl download-and-execute or write to temp",
    },
    LolBinSignature {
        binary: "wget",
        category: LolBinCategory::Download,
        abuse_patterns: &["-O /tmp/", "-O-|", "--output-document=/tmp/", "| sh", "| bash"],
        mitre_ids: &["T1105"],
        severity: Severity::High,
        description: "wget download to temp or pipe to shell",
    },
    LolBinSignature {
        binary: "ftp",
        category: LolBinCategory::Download,
        abuse_patterns: &["-n", "open", "get", "binary"],
        mitre_ids: &["T1105"],
        severity: Severity::Medium,
        description: "FTP file transfer — unusual in modern environments",
    },
    LolBinSignature {
        binary: "scp",
        category: LolBinCategory::Exfiltration,
        abuse_patterns: &["/etc/shadow", "/etc/passwd", ".ssh/", "authorized_keys"],
        mitre_ids: &["T1048"],
        severity: Severity::High,
        description: "SCP exfiltration of sensitive files",
    },
    // ── Encode / Decode ─────────────────────────────────────────────────
    LolBinSignature {
        binary: "base64",
        category: LolBinCategory::Encode,
        abuse_patterns: &["-d", "--decode", "-D"],
        mitre_ids: &["T1140"],
        severity: Severity::Medium,
        description: "Base64 decode — may indicate obfuscated payload",
    },
    LolBinSignature {
        binary: "openssl",
        category: LolBinCategory::Encode,
        abuse_patterns: &["enc -", "s_client", "-connect", "aes-256", "base64 -d"],
        mitre_ids: &["T1573.002"],
        severity: Severity::High,
        description: "OpenSSL encrypted channel or payload decryption",
    },
    // ── Compile ─────────────────────────────────────────────────────────
    LolBinSignature {
        binary: "gcc",
        category: LolBinCategory::Compile,
        abuse_patterns: &["-o /tmp/", "-shared", "-fPIC", "/tmp/"],
        mitre_ids: &["T1027.004"],
        severity: Severity::High,
        description: "On-host compilation — building malware locally",
    },
    LolBinSignature {
        binary: "clang",
        category: LolBinCategory::Compile,
        abuse_patterns: &["-o /tmp/", "-shared", "-dynamiclib", "/tmp/"],
        mitre_ids: &["T1027.004"],
        severity: Severity::High,
        description: "On-host compilation with clang",
    },
    // ── macOS Persistence ───────────────────────────────────────────────
    LolBinSignature {
        binary: "defaults",
        category: LolBinCategory::Persistence,
        abuse_patterns: &["write com.apple.loginwindow", "write loginwindow", "LoginHook", "LogoutHook"],
        mitre_ids: &["T1547.015"],
        severity: Severity::High,
        description: "macOS defaults used for login hook persistence",
    },
    LolBinSignature {
        binary: "launchctl",
        category: LolBinCategory::Persistence,
        abuse_patterns: &["load", "submit", "bootstrap"],
        mitre_ids: &["T1543.004"],
        severity: Severity::Medium,
        description: "LaunchDaemon/Agent manipulation",
    },
    LolBinSignature {
        binary: "crontab",
        category: LolBinCategory::Persistence,
        abuse_patterns: &["-e", "-l", "-r"],
        mitre_ids: &["T1053.003"],
        severity: Severity::Medium,
        description: "Cron job manipulation",
    },
    LolBinSignature {
        binary: "at",
        category: LolBinCategory::Persistence,
        abuse_patterns: &["now", "+"],
        mitre_ids: &["T1053.002"],
        severity: Severity::Medium,
        description: "at scheduled task",
    },
    // ── Credential Access ───────────────────────────────────────────────
    LolBinSignature {
        binary: "security",
        category: LolBinCategory::CredentialAccess,
        abuse_patterns: &["find-generic-password", "find-internet-password", "dump-keychain",
                          "export", "-w", "find-certificate"],
        mitre_ids: &["T1555.001"],
        severity: Severity::Critical,
        description: "macOS Keychain credential extraction",
    },
    LolBinSignature {
        binary: "dscl",
        category: LolBinCategory::CredentialAccess,
        abuse_patterns: &["read /Users", "passwd", "AuthenticationAuthority", "-read", "ShadowHashData"],
        mitre_ids: &["T1003"],
        severity: Severity::Critical,
        description: "Directory Service credential dumping",
    },
    // ── Discovery ───────────────────────────────────────────────────────
    LolBinSignature {
        binary: "networksetup",
        category: LolBinCategory::Discovery,
        abuse_patterns: &["-listallnetworkservices", "-getinfo", "-setdnsservers", "-setsocksfirewallproxy"],
        mitre_ids: &["T1016"],
        severity: Severity::Medium,
        description: "Network configuration discovery or manipulation",
    },
    LolBinSignature {
        binary: "system_profiler",
        category: LolBinCategory::Discovery,
        abuse_patterns: &["SPNetworkDataType", "SPSoftwareDataType", "SPHardwareDataType"],
        mitre_ids: &["T1082"],
        severity: Severity::Low,
        description: "System information gathering",
    },
    LolBinSignature {
        binary: "sw_vers",
        category: LolBinCategory::Discovery,
        abuse_patterns: &[],
        mitre_ids: &["T1082"],
        severity: Severity::Low,
        description: "macOS version discovery",
    },
    // ── Evasion ─────────────────────────────────────────────────────────
    LolBinSignature {
        binary: "xattr",
        category: LolBinCategory::Evasion,
        abuse_patterns: &["-d com.apple.quarantine", "-c", "-r -d"],
        mitre_ids: &["T1553.001"],
        severity: Severity::High,
        description: "Gatekeeper quarantine flag removal",
    },
    LolBinSignature {
        binary: "spctl",
        category: LolBinCategory::Evasion,
        abuse_patterns: &["--master-disable", "--disable", "--add"],
        mitre_ids: &["T1553.001"],
        severity: Severity::Critical,
        description: "Gatekeeper disable or whitelist addition",
    },
    LolBinSignature {
        binary: "csrutil",
        category: LolBinCategory::Evasion,
        abuse_patterns: &["disable"],
        mitre_ids: &["T1562.001"],
        severity: Severity::Critical,
        description: "SIP disable attempt",
    },
    LolBinSignature {
        binary: "killall",
        category: LolBinCategory::Evasion,
        abuse_patterns: &["Terminal", "Activity Monitor", "Console", "Wireshark", "tcpdump"],
        mitre_ids: &["T1562.001"],
        severity: Severity::High,
        description: "Killing security/monitoring tools",
    },
    LolBinSignature {
        binary: "pkill",
        category: LolBinCategory::Evasion,
        abuse_patterns: &["wireshark", "tcpdump", "dtrace", "fs_usage", "opensnoop"],
        mitre_ids: &["T1562.001"],
        severity: Severity::High,
        description: "Killing monitoring processes",
    },
    LolBinSignature {
        binary: "tmutil",
        category: LolBinCategory::Evasion,
        abuse_patterns: &["disable", "deletelocalsnapshots", "thinlocalsnapshots"],
        mitre_ids: &["T1490"],
        severity: Severity::High,
        description: "Time Machine backup manipulation — anti-recovery",
    },
    // ── Lateral Movement ────────────────────────────────────────────────
    LolBinSignature {
        binary: "ssh",
        category: LolBinCategory::LateralMovement,
        abuse_patterns: &["-o StrictHostKeyChecking=no", "-R ", "-L ", "-D ", "ProxyCommand"],
        mitre_ids: &["T1021.004"],
        severity: Severity::Medium,
        description: "SSH tunneling or connection with weakened security",
    },
    LolBinSignature {
        binary: "nc",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-e", "-c", "-l", "-p"],
        mitre_ids: &["T1059"],
        severity: Severity::High,
        description: "Netcat — reverse/bind shell or data transfer",
    },
    LolBinSignature {
        binary: "ncat",
        category: LolBinCategory::Execution,
        abuse_patterns: &["-e", "--exec", "-c", "--sh-exec"],
        mitre_ids: &["T1059"],
        severity: Severity::High,
        description: "Ncat — reverse/bind shell",
    },
    // ── Exfiltration ────────────────────────────────────────────────────
    LolBinSignature {
        binary: "zip",
        category: LolBinCategory::Exfiltration,
        abuse_patterns: &["-r /tmp/", "-e", "--password", "/Users/"],
        mitre_ids: &["T1560.001"],
        severity: Severity::Medium,
        description: "Archive creation for exfiltration staging",
    },
    LolBinSignature {
        binary: "tar",
        category: LolBinCategory::Exfiltration,
        abuse_patterns: &["czf /tmp/", "-cf /tmp/", "/etc/", "/Users/", ".ssh"],
        mitre_ids: &["T1560.001"],
        severity: Severity::Medium,
        description: "Tar archive for exfiltration staging",
    },
    LolBinSignature {
        binary: "ditto",
        category: LolBinCategory::Exfiltration,
        abuse_patterns: &["--rsrc", "/Users/", "/tmp/", ".app"],
        mitre_ids: &["T1560"],
        severity: Severity::Medium,
        description: "macOS ditto for file copying/staging",
    },
];

// ── Detection Result ────────────────────────────────────────────────────────

#[derive(Debug, Clone, serde::Serialize, serde::Deserialize)]
pub struct LolBinDetection {
    pub timestamp: i64,
    pub pid: u32,
    pub binary: String,
    pub full_path: String,
    pub cmdline: String,
    pub parent_name: String,
    pub parent_pid: u32,
    pub category: LolBinCategory,
    pub matched_patterns: Vec<String>,
    pub severity: Severity,
    pub confidence: f64,
    pub mitre_ids: Vec<String>,
    pub description: String,
    pub is_baseline: bool,
}

#[derive(Debug, Clone, Default, serde::Serialize, serde::Deserialize)]
pub struct LolBinStats {
    pub total_scans: u64,
    pub total_detections: u64,
    pub by_category: HashMap<String, u64>,
    pub by_binary: HashMap<String, u64>,
    pub baseline_entries: u64,
    pub last_scan_at: i64,
}

// ── Main Detector ───────────────────────────────────────────────────────────

pub struct LOLBinDetector {
    // Breakthrough #2: TieredCache
    detection_cache: TieredCache<u32, Vec<LolBinDetection>>,
    // Breakthrough #1: HierarchicalState
    detection_history: RwLock<HierarchicalState<LolBinStats>>,
    // Breakthrough #3: ReversibleComputation — cmdline scoring
    cmdline_scorer: RwLock<ReversibleComputation<u64, u64>>,
    // Breakthrough #5: StreamAccumulator
    detection_rate: RwLock<StreamAccumulator<f64, f64>>,
    // Breakthrough #461: DifferentialStore — baseline diffs
    baseline_diffs: RwLock<DifferentialStore<String, Vec<String>>>,
    // Breakthrough #569: PruningMap
    recent_detections: RwLock<PruningMap<String, LolBinDetection>>,
    // Breakthrough #592: DedupStore
    dedup: RwLock<DedupStore<String, Vec<u8>>>,
    // Breakthrough #627: SparseMatrix — binary × category incidence
    binary_matrix: RwLock<SparseMatrix<u32, u32, u64>>,
    // Breakthrough #6: MemoryMetrics
    metrics: MemoryMetrics,
    // Baseline: known normal LOLBin usage patterns (binary + args hash)
    baseline: RwLock<HashSet<String>>,
    // Stats
    stats: RwLock<LolBinStats>,
    total_scans: AtomicU64,
}

impl LOLBinDetector {
    pub fn new() -> Self {
        let metrics = MemoryMetrics::new(8 * 1024 * 1024);

        let detection_cache = TieredCache::new(5000)
            ;

        let detection_history = HierarchicalState::new(HISTORY_LEVELS, HISTORY_PER_LEVEL);

        let cmdline_scorer = ReversibleComputation::new(
            512,
            |_items: &[u64]| { _items.len() as u64 },
        );

        let detection_rate = StreamAccumulator::new(STATS_WINDOW, 0.0f64, |acc: &mut f64, items: &[f64]| { for &v in items { *acc += v; } });
        let baseline_diffs = DifferentialStore::new().with_max_chain(64);
        let recent_detections = PruningMap::new(DETECTION_CACHE_MAX);
        let dedup = DedupStore::new();
        let binary_matrix = SparseMatrix::new(0u64);

        Self {
            detection_cache,
            detection_history: RwLock::new(detection_history),
            cmdline_scorer: RwLock::new(cmdline_scorer),
            detection_rate: RwLock::new(detection_rate),
            baseline_diffs: RwLock::new(baseline_diffs),
            recent_detections: RwLock::new(recent_detections),
            dedup: RwLock::new(dedup),
            binary_matrix: RwLock::new(binary_matrix),
            metrics,
            baseline: RwLock::new(HashSet::new()),
            stats: RwLock::new(LolBinStats::default()),
            total_scans: AtomicU64::new(0),
        }
    }

    /// Scan all running processes for LOLBin abuse.
    pub fn scan(&self) -> Vec<LolBinDetection> {
        let start = std::time::Instant::now();
        self.total_scans.fetch_add(1, Ordering::Relaxed);

        let mut sys = sysinfo::System::new_all();
        sys.refresh_all();

        let mut detections = Vec::new();

        for (pid, proc_info) in sys.processes() {
            let pid_u32 = pid.as_u32();
            let name = proc_info.name().to_string();
            let cmdline = proc_info.cmd().join(" ");
            let exe_path = proc_info.exe()
                .map(|p| p.to_string_lossy().to_string())
                .unwrap_or_default();

            // Match against LOLBin database
            for sig in LOLBIN_DB {
                if name != sig.binary && !exe_path.ends_with(&format!("/{}", sig.binary)) {
                    continue;
                }

                // Check if any abuse patterns match
                let cmd_lower = cmdline.to_lowercase();
                let matched: Vec<String> = sig.abuse_patterns.iter()
                    .filter(|p| cmd_lower.contains(&p.to_lowercase()))
                    .map(|p| p.to_string())
                    .collect();

                // If no specific patterns and the sig has patterns, skip
                if matched.is_empty() && !sig.abuse_patterns.is_empty() {
                    continue;
                }

                // Check baseline (Breakthrough #461)
                let baseline_key = format!("{}:{}", sig.binary, self.normalize_cmdline(&cmdline));
                let is_baseline = self.baseline.read().contains(&baseline_key);

                // Compute confidence (Breakthrough #3)
                let patterns_vec: Vec<String> = sig.abuse_patterns.iter().map(|s| s.to_string()).collect();
                let cmd_lower = cmdline.to_lowercase();
                let score: f64 = patterns_vec.iter()
                    .filter(|p| cmd_lower.contains(&p.to_lowercase()))
                    .count() as f64 * 25.0;
                let confidence = if is_baseline { 0.3 } else { (score / 100.0).max(0.5) };
        // Breakthrough #1: HierarchicalState — checkpoint stats at O(log n)
        self.detection_history.write().checkpoint(self.stats.read().clone());
        // Breakthrough #3: ReversibleComputation — feed event into risk model
        self.cmdline_scorer.write().push(1u64);
        // Breakthrough #5: StreamAccumulator — accumulate event rate
        self.detection_rate.write().push(1.0);
        // Breakthrough #2: TieredCache — cache lookup
        let _ = self.detection_cache.get(&0u32);
        // Breakthrough #592: DedupStore — deduplicate
        self.dedup.write().insert("chk".into(), format!("{:?}", std::time::SystemTime::now()).into_bytes());
        // Breakthrough #2: TieredCache — cache event for fast lookup
        // (TieredCache is used passively via .get()/.insert() in detection paths)

                let parent_pid = proc_info.parent().map(|p| p.as_u32()).unwrap_or(0);
                let parent_name = sys.process(sysinfo::Pid::from_u32(parent_pid))
                    .map(|p| p.name().to_string())
                    .unwrap_or_default();

                let detection = LolBinDetection {
                    timestamp: chrono::Utc::now().timestamp(),
                    pid: pid_u32,
                    binary: sig.binary.to_string(),
                    full_path: exe_path.clone(),
                    cmdline: cmdline.clone(),
                    parent_name,
                    parent_pid,
                    category: sig.category,
                    matched_patterns: matched,
                    severity: if is_baseline { Severity::Low } else { sig.severity },
                    confidence,
                    mitre_ids: sig.mitre_ids.iter().map(|s| s.to_string()).collect(),
                    description: sig.description.to_string(),
                    is_baseline,
                };

                // Dedup (Breakthrough #592)
                let dedup_key = format!("{}:{}:{}", pid_u32, sig.binary, cmdline.len());
                if {{{ let mut _d = self.dedup.write(); _d.insert(dedup_key.clone(), vec![]); true }}} {
                    // Cache (Breakthrough #569)
                    let cache_key = format!("{}:{}", pid_u32, sig.binary);
                    self.recent_detections.write().insert_with_priority(
                        cache_key, detection.clone(), confidence,
                    );

                    // Update matrix (Breakthrough #627)
                    let cat_id = sig.category as u32;
                    let current = *self.binary_matrix.read().get(&pid_u32, &cat_id);
                    self.binary_matrix.write().set(pid_u32, cat_id, current + 1);

                    detections.push(detection);
                }
            }
        }

        // Update stats
        let elapsed = start.elapsed().as_micros() as u64;
        {
            let mut stats = self.stats.write();
            stats.total_scans += 1;
            stats.total_detections += detections.len() as u64;
            stats.baseline_entries = self.baseline.read().len() as u64;
            stats.last_scan_at = chrono::Utc::now().timestamp();
            for d in &detections {
                let cat = format!("{:?}", d.category);
                *stats.by_category.entry(cat).or_default() += 1;
                *stats.by_binary.entry(d.binary.clone()).or_default() += 1;
            }
        }

        // Stream accumulator (Breakthrough #5)
        self.detection_rate.write().push(detections.len() as f64);

        // Checkpoint (Breakthrough #1)
        self.detection_history.write().checkpoint(self.stats.read().clone());

        info!("LOLBin scan: {} detections in {:.1}ms", detections.len(), elapsed as f64 / 1000.0);
        detections
    }

    /// Learn current LOLBin usage as baseline (reduces future FPs).
    pub fn learn_baseline(&self) {
        let mut sys = sysinfo::System::new_all();
        sys.refresh_all();

        let mut new_entries = Vec::new();
        for (_pid, proc_info) in sys.processes() {
            let name = proc_info.name().to_string();
            let cmdline = proc_info.cmd().join(" ");
            for sig in LOLBIN_DB {
                if name == sig.binary {
                    let key = format!("{}:{}", sig.binary, self.normalize_cmdline(&cmdline));
                    new_entries.push(key);
                }
            }
        }

        let count = new_entries.len();
        self.baseline.write().extend(new_entries.clone());
        self.baseline_diffs.write().record_insert("baseline".into(), new_entries);
        info!("LOLBin baseline learned: {} entries", count);
    }

    fn normalize_cmdline(&self, cmdline: &str) -> String {
        // Normalize by removing variable parts (PIDs, timestamps, etc.)
        let mut normalized = cmdline.to_string();
        // Remove numeric-only arguments (likely PIDs or ports)
        normalized = normalized.split_whitespace()
            .filter(|w| !w.chars().all(|c| c.is_ascii_digit()))
            .collect::<Vec<_>>()
            .join(" ");
        // Truncate long args
        if normalized.len() > 200 {
            normalized.truncate(200);
        }
        normalized
    }

    /// Get statistics.
    pub fn stats(&self) -> LolBinStats {
        self.stats.read().clone()
    }

    /// Get memory metrics.
    pub fn metrics(&self) -> &MemoryMetrics {
        &self.metrics
    }
}
